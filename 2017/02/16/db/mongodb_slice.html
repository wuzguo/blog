<!DOCTYPE HTML>
<html class="no-js" lang="zh-CN">
<!--
//                            _ooOoo_
//                           o8888888o
//                           88" . "88
//                           (| -_- |)
//                            O\ = /O
//                        ____/`---'\____
//                      .   ' \\| |// `.
//                       / \\||| : |||// \
//                     / _||||| -:- |||||- \
//                       | | \\\ - /// | |
//                     | \_| ''\---/'' | |
//                      \ .-\__ `-` ___/-. /
//                   ___`. .' /--.--\ `. . __
//                ."" '< `.___\_<|>_/___.' >'"".
//               | | : `- \`.;`\ _ /`;.`/ - ` : | |
//                 \ \ `-. \_ __\ /__ _/ .-` / /
//         ======`-.____`-.___\_____/___.-`____.-'======
//                            `=---='
//                 拦截插件累计拦截逗比攻击"1381438"次！
//         .............................................
//                  佛祖保佑             永无BUG
//          佛曰:
//                  写字楼里写字间，写字间里程序员；
//                  程序人员写程序，又拿程序换酒钱。
//                  酒醒只在网上坐，酒醉还来网下眠；
//                  酒醉酒醒日复日，网上网下年复年。
//                  但愿老死电脑间，不愿鞠躬老板前；
//                  奔驰宝马贵者趣，公交自行程序员。
//                  别人笑我忒疯癫，我笑自己命太贱；
//                  不见满街漂亮妹，哪个归得程序员？
-->
<head>
    <!--[if lte IE 9]>
<meta http-equiv="refresh" content="0;url=http://wuzguo.com/blog/warn.html">
<![endif]-->
<meta charset="utf-8">

<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no">
<meta http-equiv="mobile-agent" content="format=html5; url=http://wuzguo.com/blog">
<meta name="author" content="Zàk (https://github.com/wuzguo)">

<link rel="stylesheet" href="/blog/css/SimpleStyle.css">


<!--代码高亮-->

<link rel="stylesheet" href="/blog/css/highlight/styles/default.css">

<!--使用Github风格的代码样式-->

<link rel="stylesheet" href="/blog/css/highlight/styles/github.css">


<link rel="shortcut icon" href="/blog/images/fav.ico">


<title>
    
    构建mongodb ha集群：副本集和分片 -
    
    Zak&#39;s Home
    
</title>

<meta name="keywords" content="MongoDB，HA集群，副本集，分片">

<meta name="description " content="构建MongoDB HA集群">
<meta name="generator" content="Hexo 6.2.0"></head>
<body>
<div id="nav">
    <nav class="nav-menu">
        <a class="site-name current" href="/blog/" title="Zàk">Zàk</a>
        <a class="site-index current" href="/blog/"><i class="fa fa-home"></i><span>首页</span></a>
        <a href="/blog/archives/" title="归档"><i class="fa fa-archives"></i><span>归档</span></a>
        <a href="/blog/tags/" title="标签"><i class="fa fa-tags"></i><span>标签</span></a>
        <a href="/blog/video/" title="视频"><i class="fa fa-video-camera"></i><span>视频</span></a>
        <a href="/blog/cross_fire/" title="链接"><i class="fa fa-wifi"></i><span>链接</span></a>
        <a href="/blog/help/" title="帮助"><i class="fa fa-question-circle"></i><span>帮助</span></a>
    </nav>
</div>
<div class="nav-user">
    <a class="btn-search" href="#"><i class="fa fa-search"></i></a>
    <a class="btn-read-mode" href="#"><i class="fa fa-sun-o"></i></a>
    <a class="btn-weixin-mp" href="javascript:"><i class="fa fa-weixin"></i></a>
</div>
<div id="wrapper" class="clearfix">
    <div id="body">
        <div class="main" id="main">
            <div id="cover">
    <div class="cover-img"></div>
    <div class="cover-info">
        <img class="avatar" width="72" src="/blog/images/avatar.png" alt="avatar" />
        <h1>Zàk</h1>
        <h4>日拱一卒，功不唐捐</h4>
        <p>一个追求进步的「十八线码农」</p>
        <div class="cover-sns">
            <div class="btn btn-homepage">
                <a href="http://wuzguo.com" target="_blank" rel="nofollow"><i class="fa fa-homepage"></i></a>
            </div>
            <div class="btn btn-github">
                <a href="https://github.com/wuzguo"  target="_blank" rel="nofollow"><i class="fa fa-github"></i></a>
            </div>
            <div class="btn btn-stack-overflow">
                <a href="https://stackoverflow.com/users/6716643/wuzguo" target="_blank" rel="nofollow"><i class="fa fa-stack-overflow"></i></a>
            </div>
            <div class="btn btn-facebook">
                <a href="https://www.facebook.com/wu.xsen"  target="_blank" rel="nofollow"><i class="fa fa-facebook"></i></a>
            </div>
        </div>
    </div>
</div>
            <div class="page-title">
    <ul>
        <li><a href="/blog/">最新</a></li>
        
            
                <li class="">
                    <a href="/blog/categories/server/" data-name="后台">后台</a>
                </li>
            
                <li class="">
                    <a href="/blog/categories/front/" data-name="前端">前端</a>
                </li>
            
                <li class="active">
                    <a href="/blog/categories/db/" data-name="数据库">数据库</a>
                </li>
            
                <li class="">
                    <a href="/blog/categories/os/" data-name="操作系统">操作系统</a>
                </li>
            
                <li class="">
                    <a href="/blog/categories/iot/" data-name="IoT">IoT</a>
                </li>
            
                <li class="">
                    <a href="/blog/categories/bigdata/" data-name="大数据">大数据</a>
                </li>
            
                <li class="">
                    <a href="/blog/categories/tools/" data-name="工具">工具</a>
                </li>
            
                <li class="">
                    <a href="/blog/categories/others/" data-name="其他">其他</a>
                </li>
            
        
        <li class="page-search">
    <form id="search" class="search-form">
        <label for="s" class="sr-only">请输入关键字</label>
        <input class="search-field" type="text" name="s" class="text" placeholder="请输入关键字" />
        <button type="submit" class="search-form-submit" title="搜索"><i class="fa fa-search"></i></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="请输入关键词..."/>
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(无标题)',
        },
        ROOT_URL: '/blog/',
        CONTENT_URL: '/blog/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
</li>

    </ul>
</div>
<div class="main-inner">
    <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
        <div class="post-header">
            <div class="post-author clearfix">
                <a class="avatar fleft" href="http://www.wuzguo.com" target="_blank">
                    <img width="48" src="/blog/images/avatar.png" alt="avatar"/>
                </a>
                <p><span class="label">作者</span>
                    <a href="https://github.com/wuzguo" target="_blank">Zak</a>
                    <span title="最后编辑于2017-02-16">2017-02-16</span>
                </p>
                <p>一个追求进步的「十八线码农」</p>
            </div>
            <h2 class="post-title">构建MongoDB HA集群：副本集和分片</h2>
            <div class="post-meta">
                本文总共15891个字 | 您是第<span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span>位看到它们的小伙伴
            </div>
        </div>
        <div class="post-content markdown-body">
            <p>MongoDB复制是将数据同步在多个服务器的过程。</p>
<p>复制提供了数据的冗余备份，并在多个服务器上存储数据副本，提高了数据的可用性， 并可以保证数据的安全性。</p>
<p>复制还允许您从硬件故障和服务中断中恢复数据。</p>
<h2 id="复制原理"><a href="#复制原理" class="headerlink" title="复制原理"></a>复制原理</h2><p>mongodb的复制至少需要两个节点。其中一个是主节点，负责处理客户端请求，其余的都是从节点，负责复制主节点上的数据。</p>
<p>mongodb各个节点常见的搭配方式为：一主一从、一主多从。</p>
<p>主节点记录在其上的所有操作oplog，从节点定期轮询主节点获取这些操作，然后对自己的数据副本执行这些操作，从而保证从节点的数据与主节点一致。</p>
<p>MongoDB复制结构图如下所示：</p>
<p><img src="/blog/images/201701/replication.png" alt="MongoDB复制结构图"></p>
<p>以上结构图总，客户端总主节点读取数据，在客户端写入数据到主节点是， 主节点与从节点进行数据交互保障数据的一致性。</p>
<h3 id="副本集特征："><a href="#副本集特征：" class="headerlink" title="副本集特征："></a>副本集特征：</h3><ul>
<li>N 个节点的集群</li>
<li>任何节点可作为主节点</li>
<li>所有写入操作都在主节点上</li>
<li>自动故障转移</li>
<li>自动恢复</li>
</ul>
<hr>
<h2 id="副本集设置"><a href="#副本集设置" class="headerlink" title="副本集设置"></a>副本集设置</h2><p>在本教程中我们使用同一个MongoDB来做MongoDB主从的实验， 操作步骤如下：</p>
<p>1、关闭正在运行的MongoDB服务器。</p>
<p>现在我们通过指定 –replSet 选项来启动mongoDB。–replSet 基本语法格式如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mongod --port &quot;PORT&quot; --dbpath &quot;YOUR_DB_DATA_PATH&quot; --replSet &quot;REPLICA_SET_INSTANCE_NAME&quot;</span><br></pre></td></tr></table></figure>

<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mongod --port 27017 --dbpath &quot;D:\set up\mongodb\data&quot; --replSet rs0</span><br></pre></td></tr></table></figure>

<p>以上实例会启动一个名为rs0的MongoDB实例，其端口号为27017。</p>
<p>启动后打开命令提示框并连接上mongoDB服务。</p>
<p>在Mongo客户端使用命令rs.initiate()来启动一个新的副本集。</p>
<p>我们可以使用rs.conf()来查看副本集的配置</p>
<p>查看副本集状态使用 rs.status() 命令</p>
<hr>
<h2 id="副本集添加成员"><a href="#副本集添加成员" class="headerlink" title="副本集添加成员"></a>副本集添加成员</h2><p>添加副本集的成员，我们需要使用多条服务器来启动mongo服务。进入Mongo客户端，并使用rs.add()方法来添加副本集的成员。</p>
<h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><p>rs.add() 命令基本语法格式如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">rs.add(HOST_NAME:PORT)</span></span><br></pre></td></tr></table></figure>

<h3 id="实例-1"><a href="#实例-1" class="headerlink" title="实例"></a>实例</h3><p>假设你已经启动了一个名为mongod1.net，端口号为27017的Mongo服务。 在客户端命令窗口使用rs.add() 命令将其添加到副本集中，命令如下所示：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">rs.add(<span class="string">&quot;mongod1.net:27017&quot;</span>)</span></span><br><span class="line"><span class="meta prompt_">&gt;</span></span><br></pre></td></tr></table></figure>

<p>MongoDB中你只能通过主节点将Mongo服务添加到副本集中， 判断当前运行的Mongo服务是否为主节点可以使用命令db.isMaster() 。</p>
<p>MongoDB的副本集与我们常见的主从有所不同，主从在主机宕机后所有服务将停止，而副本集在主机宕机后，副本会接管主节点成为主节点，不会出现宕机的情况。</p>
<h2 id="分片原理"><a href="#分片原理" class="headerlink" title="分片原理"></a>分片原理</h2><p>在Mongodb里面存在另一种集群，就是分片技术,可以满足MongoDB数据量大量增长的需求。</p>
<p>当MongoDB存储海量的数据时，一台机器可能不足以存储数据，也可能不足以提供可接受的读写吞吐量。这时，我们就可以通过在多台机器上分割数据，使得数据库系统能存储和处理更多的数据。</p>
<p>下图展示了在MongoDB中使用分片集群结构分布：</p>
<p><img src="/blog/images/201701/sharding.png" alt="img"></p>
<p>上图中主要有如下所述三个主要组件：</p>
<ul>
<li>**Shard:**用于存储实际的数据块，实际生产环境中一个shard server角色可由几台机器组个一个replica set承担，防止主机单点故障</li>
<li>**Config Server:**mongod实例，存储了整个 ClusterMetadata，其中包括 chunk信息。</li>
<li>**Query Routers:**前端路由，客户端由此接入，且让整个集群看上去像单一数据库，前端应用可以透明使用。</li>
</ul>
<hr>
<h2 id="分片实例"><a href="#分片实例" class="headerlink" title="分片实例"></a>分片实例</h2><p>分片结构端口分布如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Shard Server 1：10001</span><br><span class="line">Shard Server 2：10002</span><br><span class="line">Shard Server 3：10003</span><br><span class="line">Config Server ：11000</span><br><span class="line">Route Process：10000</span><br></pre></td></tr></table></figure>

<p>步骤一：启动Shard Server</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@100 /]# mkdir -p /www/mongoDB/shard/s0</span><br><span class="line">[root@100 /]# mkdir -p /www/mongoDB/shard/s1</span><br><span class="line">[root@100 /]# mkdir -p /www/mongoDB/shard/s2</span><br><span class="line">[root@100 /]# mkdir -p /www/mongoDB/shard/s3</span><br><span class="line">[root@100 /]# mkdir -p /www/mongoDB/shard/log</span><br><span class="line">[root@100 /]# /usr/local/mongoDB/bin/mongod --port 10001 --dbpath=/www/mongoDB/shard/s0 --logpath=/www/mongoDB/shard/log/s0.log --logappend --fork</span><br><span class="line">....</span><br><span class="line">[root@100 /]# /usr/local/mongoDB/bin/mongod --port 10003 --dbpath=/www/mongoDB/shard/s2 --logpath=/www/mongoDB/shard/log/s3.log --logappend --fork</span><br></pre></td></tr></table></figure>

<p>步骤二： 启动Config Server</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@100 /]# mkdir -p /www/mongoDB/shard/config</span><br><span class="line">[root@100 /]# /usr/local/mongoDB/bin/mongod --port 11000 --dbpath=/www/mongoDB/shard/config --logpath=/www/mongoDB/shard/log/config.log --logappend --fork</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>这里我们完全可以像启动普通mongodb服务一样启动，不需要添加—shardsvr和configsvr参数。因为这两个参数的作用就是改变启动端口的，所以我们自行指定了端口就可以。</p>
<p>步骤三： 启动Route Process</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">/usr/local/mongoDB/bin/mongos --port 10000 --configdb localhost:11000 --fork --logpath=/www/mongoDB/shard/log/route.log --chunkSize 500</span><br></pre></td></tr></table></figure>

<p>mongos启动参数中，chunkSize这一项是用来指定chunk的大小的，单位是MB，默认大小为200MB.</p>
<p>步骤四： 配置Sharding</p>
<p>接下来，我们使用MongoDB Shell登录到mongos，添加Shard节点</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@100 shard]# /usr/local/mongoDB/bin/mongo admin --port 40000</span><br><span class="line">MongoDB shell version: 2.0.7</span><br><span class="line">connecting to: 127.0.0.1:10000/admin</span><br><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash">db.runCommand(&#123; addshard:<span class="string">&quot;localhost:10001&quot;</span> &#125;)</span></span><br><span class="line">&#123; &quot;shardAdded&quot; : &quot;shard0000&quot;, &quot;ok&quot; : 1 &#125;</span><br><span class="line">......</span><br><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash">db.runCommand(&#123; addshard:<span class="string">&quot;localhost:10003&quot;</span> &#125;)</span></span><br><span class="line">&#123; &quot;shardAdded&quot; : &quot;shard0002&quot;, &quot;ok&quot; : 1 &#125;</span><br><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash">db.runCommand(&#123; enablesharding:<span class="string">&quot;test&quot;</span> &#125;) <span class="comment">#设置分片存储的数据库</span></span></span><br><span class="line">&#123; &quot;ok&quot; : 1 &#125;</span><br><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash">db.runCommand(&#123; shardcollection: <span class="string">&quot;test.log&quot;</span>, key: &#123; <span class="built_in">id</span>:1,time:1&#125;&#125;)</span></span><br><span class="line">&#123; &quot;collectionsharded&quot; : &quot;test.log&quot;, &quot;ok&quot; : 1 &#125;</span><br></pre></td></tr></table></figure>

<p>步骤五： 程序代码内无需太大更改，直接按照连接普通的mongo数据库那样，将数据库连接接入接口10000</p>
<hr>
<p>##分片和副本集结合</p>
<p>以下文档引用至：</p>
<p>首先确定各个组件的数量，mongos 3个， config server 3个，数据分3片 shard server 3个，每个shard 有一个副本一个仲裁也就是 3 * 2 &#x3D; 6 个，总共需要部署15个实例。这些实例可以部署在独立机器也可以部署在一台机器，我们这里测试资源有限，只准备了 3台机器，在同一台机器只要端口不同就可以，看一下物理部署图：</p>
<p><img src="/blog/images/201701/1.png" alt="1"></p>
<p>架构搭好了，安装软件。</p>
<p>1、准备机器，IP分别设置为： 192.168.0.136、192.168.0.137、192.168.0.138。</p>
<p>2、分别在每台机器上建立mongodb分片对应测试文件夹。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">存放mongodb数据文件</span></span><br><span class="line">mkdir -p /data/mongodbtest</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">进入mongodb文件夹</span></span><br><span class="line">cd  /data/mongodbtest</span><br></pre></td></tr></table></figure>
<p>3、下载mongodb的安装程序包</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget http://fastdl.mongodb.org/linux/mongodb-linux-x86_64-2.4.8.tgz</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">解压下载的压缩包</span></span><br><span class="line">tar xvzf mongodb-linux-x86_64-2.4.8.tgz</span><br></pre></td></tr></table></figure>
<p>4、分别在每台机器建立mongos 、config 、 shard1 、shard2、shard3 五个目录。<br>因为mongos不存储数据，只需要建立日志文件目录即可。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">建立mongos目录</span></span><br><span class="line"></span><br><span class="line">mkdir -p /data/mongodbtest/mongos/log</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">建立config server 数据文件存放目录</span></span><br><span class="line">mkdir -p /data/mongodbtest/config/data</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">建立config server 日志文件存放目录</span></span><br><span class="line">mkdir -p /data/mongodbtest/config/log</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">建立config server 日志文件存放目录</span></span><br><span class="line">mkdir -p /data/mongodbtest/mongos/log</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">建立shard1 数据文件存放目录</span></span><br><span class="line">mkdir -p /data/mongodbtest/shard1/data</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">建立shard1 日志文件存放目录</span></span><br><span class="line">mkdir -p /data/mongodbtest/shard1/log</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">建立shard2 数据文件存放目录</span></span><br><span class="line">mkdir -p /data/mongodbtest/shard2/data</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">建立shard2 日志文件存放目录</span></span><br><span class="line">mkdir -p /data/mongodbtest/shard2/log</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">建立shard3 数据文件存放目录</span></span><br><span class="line">mkdir -p /data/mongodbtest/shard3/data</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">建立shard3 日志文件存放目录</span></span><br><span class="line">mkdir -p /data/mongodbtest/shard3/log</span><br></pre></td></tr></table></figure>
<p>5、规划5个组件对应的端口号，由于一个机器需要同时部署 mongos、config server 、shard1、shard2、shard3，所以需要用端口进行区分。<br>这个端口可以自由定义，在本文 mongos为 20000， config server 为 21000， shard1为 22001 ， shard2为22002， shard3为22003.</p>
<p>6、在每一台服务器分别启动配置服务器。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">/data/mongodbtest/mongodb-linux-x86_64-2.4.8/bin/mongod --configsvr --dbpath /data/mongodbtest/config/data --port 21000 --logpath /data/mongodbtest/config/log/config.log --fork</span><br></pre></td></tr></table></figure>
<p>7、在每一台服务器分别启动mongos服务器。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">/data/mongodbtest/mongodb-linux-x86_64-2.4.8/bin/mongos  --configdb 192.168.0.136:21000,192.168.0.137:21000,192.168.0.138:21000  --port 20000   --logpath  /data/mongodbtest/mongos/log/mongos.log --fork</span><br></pre></td></tr></table></figure>
<p>！！！注意，报错：</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">BadValue: configdb supports <span class="keyword">only</span> <span class="keyword">replica</span> <span class="keyword">set</span> <span class="keyword">connection</span> string</span><br></pre></td></tr></table></figure>

<p>查看MongoDB的帮助发现在3.2版本以后，configdb的方式已经变成了： </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">configReplSet/&lt;cfgsvr1:port1&gt;,&lt;cfgsvr2:port2&gt;,&lt;cfgsvr3:port3&gt;</span><br></pre></td></tr></table></figure>

<p>解决方案：</p>
<p>登录configdb 在mongo中执行：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">rs.initiate( &#123;_id: &quot;configReplSet&quot;,</span><br><span class="line">              configsvr: true,</span><br><span class="line">              members:[</span><br><span class="line">    		   &#123; _id: 0, host: &quot;192.168.190.136:21000&quot;&#125;,</span><br><span class="line">    		   &#123; _id: 1, host: &quot;192.168.190.137:21000&quot;&#125;,</span><br><span class="line">    		   &#123; _id: 2, host: &quot;192.168.190.138:21000&quot;&#125;</span><br><span class="line">               ]</span><br><span class="line">          &#125; )</span><br></pre></td></tr></table></figure>
<p>8、配置各个分片的副本集。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在每个机器里分别设置分片1服务器及副本集shard1</span></span><br><span class="line"></span><br><span class="line">/data/mongodbtest/mongodb-linux-x86_64-2.4.8/bin/mongod --shardsvr --replSet shard1 --port 22001 --dbpath /data/mongodbtest/shard1/data  --logpath /data/mongodbtest/shard1/log/shard1.log --fork --nojournal  --oplogSize 10</span><br></pre></td></tr></table></figure>
<p>为了快速启动并节约测试环境存储空间，这里加上 nojournal 是为了关闭日志信息，在我们的测试环境不需要初始化这么大的redo日志。同样设置 oplogsize是为了降低 local 文件的大小，oplog是一个固定长度的 capped collection,它存在于”local”数据库中,用于记录Replica Sets操作日志。注意，这里的设置是为了测试！</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在每个机器里分别设置分片2服务器及副本集shard2</span></span><br><span class="line"></span><br><span class="line">/data/mongodbtest/mongodb-linux-x86_64-2.4.8/bin/mongod --shardsvr --replSet shard2 --port 22002 --dbpath /data/mongodbtest/shard2/data  --logpath /data/mongodbtest/shard2/log/shard2.log --fork --nojournal  --oplogSize 10</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在每个机器里分别设置分片3服务器及副本集shard3</span></span><br><span class="line"></span><br><span class="line">/data/mongodbtest/mongodb-linux-x86_64-2.4.8/bin/mongod --shardsvr --replSet shard3 --port 22003 --dbpath /data/mongodbtest/shard3/data  --logpath /data/mongodbtest/shard3/log/shard3.log --fork --nojournal  --oplogSize 10</span><br></pre></td></tr></table></figure>
<p>分别对每个分片配置副本集，深入了解副本集参考本系列前几篇文章。</p>
<p>任意登陆一个机器，比如登陆192.168.0.136，连接mongodb</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置第一个分片副本集</span></span><br><span class="line"></span><br><span class="line">/data/mongodbtest/mongodb-linux-x86_64-2.4.8/bin/mongo  127.0.0.1:22001</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">使用admin数据库</span></span><br><span class="line"></span><br><span class="line">use admin</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">定义副本集配置</span></span><br><span class="line"></span><br><span class="line">config = &#123; _id:&quot;shard1&quot;, members:[</span><br><span class="line">				 &#123;_id:0,host:&quot;192.168.0.136:22001&quot;&#125;,</span><br><span class="line">				 &#123;_id:1,host:&quot;192.168.0.137:22001&quot;&#125;,</span><br><span class="line">				 &#123;_id:2,host:&quot;192.168.0.138:22001&quot;,arbiterOnly:true&#125;</span><br><span class="line">	            ]</span><br><span class="line">	     &#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">初始化副本集配置</span></span><br><span class="line"></span><br><span class="line">rs.initiate(config);</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置第二个分片副本集</span></span><br><span class="line"></span><br><span class="line">/data/mongodbtest/mongodb-linux-x86_64-2.4.8/bin/mongo  127.0.0.1:22002</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">使用admin数据库</span></span><br><span class="line"></span><br><span class="line">use admin</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">定义副本集配置</span></span><br><span class="line"></span><br><span class="line">config = &#123; _id:&quot;shard2&quot;, members:[</span><br><span class="line">				 &#123;_id:0,host:&quot;192.168.0.136:22002&quot;&#125;,</span><br><span class="line">				 &#123;_id:1,host:&quot;192.168.0.137:22002&quot;&#125;,</span><br><span class="line">				 &#123;_id:2,host:&quot;192.168.0.138:22002&quot;,arbiterOnly:true&#125;</span><br><span class="line">	            ]</span><br><span class="line">	     &#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">初始化副本集配置</span></span><br><span class="line"></span><br><span class="line">rs.initiate(config);</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置第三个分片副本集</span></span><br><span class="line"></span><br><span class="line">/data/mongodbtest/mongodb-linux-x86_64-2.4.8/bin/mongo    127.0.0.1:22003</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">使用admin数据库</span></span><br><span class="line"></span><br><span class="line">use admin</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">定义副本集配置</span></span><br><span class="line"></span><br><span class="line">config = &#123;_id:&quot;shard3&quot;, members:[</span><br><span class="line">				 &#123;_id:0,host:&quot;192.168.0.136:22003&quot;&#125;,</span><br><span class="line">				 &#123;_id:1,host:&quot;192.168.0.137:22003&quot;&#125;,</span><br><span class="line">				 &#123;_id:2,host:&quot;192.168.0.138:22003&quot;,arbiterOnly:true&#125;</span><br><span class="line">	            ]</span><br><span class="line">	     &#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">初始化副本集配置</span></span><br><span class="line"></span><br><span class="line">rs.initiate(config);</span><br></pre></td></tr></table></figure>
<p>9、目前搭建了mongodb配置服务器、路由服务器，各个分片服务器，不过应用程序连接到 mongos 路由服务器并不能使用分片机制，还需要在程序里设置分片配置，让分片生效。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">连接到mongos</span></span><br><span class="line"></span><br><span class="line">/data/mongodbtest/mongodb-linux-x86_64-2.4.8/bin/mongo  127.0.0.1:20000</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">使用admin数据库</span></span><br><span class="line"></span><br><span class="line">user  admin</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">串联路由服务器与分配副本集1</span></span><br><span class="line"></span><br><span class="line">db.runCommand( &#123; addshard : &quot;shard1/192.168.0.136:22001,192.168.0.137:22001,192.168.0.138:22001&quot;&#125;);</span><br></pre></td></tr></table></figure>
<p>如里shard是单台服务器，用</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">db.run<span class="constructor">Command( &#123; <span class="params">addshard</span> : “[: ]” &#125; )</span></span><br></pre></td></tr></table></figure>
<p>这样的命令加入，如果shard是副本集，用</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">db.run<span class="constructor">Command( &#123; <span class="params">addshard</span> : “<span class="params">replicaSetName</span><span class="operator">/</span>[:<span class="params">port</span>[,<span class="params">serverhostname2</span>[:<span class="params">port</span>],…]” &#125;)</span>;</span><br></pre></td></tr></table></figure>
<p>这样的格式表示 。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">串联路由服务器与分配副本集2</span></span><br><span class="line"></span><br><span class="line">db.runCommand( &#123; addshard : &quot;shard2/192.168.0.136:22002,192.168.0.137:22002,192.168.0.138:22002&quot;&#125;);</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">串联路由服务器与分配副本集3</span></span><br><span class="line"></span><br><span class="line">db.runCommand( &#123; addshard : &quot;shard3/192.168.0.136:22003,192.168.0.137:22003,192.168.0.138:22003&quot;&#125;);</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看分片服务器的配置</span></span><br><span class="line"></span><br><span class="line">db.runCommand( &#123; listshards : 1 &#125; );</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">内容输出</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	 &quot;shards&quot; : [</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;_id&quot; : &quot;shard1&quot;,</span><br><span class="line">			&quot;host&quot; : &quot;shard1/192.168.0.136:22001,192.168.0.137:22001&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;_id&quot; : &quot;shard2&quot;,</span><br><span class="line">			&quot;host&quot; : &quot;shard2/192.168.0.136:22002,192.168.0.137:22002&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;_id&quot; : &quot;shard3&quot;,</span><br><span class="line">			&quot;host&quot; : &quot;shard3/192.168.0.136:22003,192.168.0.137:22003&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	],</span><br><span class="line">	&quot;ok&quot; : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为192.168.0.138是每个分片副本集的仲裁节点，所以在上面结果没有列出来。<br>10、目前配置服务、路由服务、分片服务、副本集服务都已经串联起来了，但我们的目的是希望插入数据，数据能够自动分片，就差那么一点点，一点点。。。连接在mongos上，准备让指定的数据库、指定的集合分片生效。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">指定testdb分片生效</span></span><br><span class="line"></span><br><span class="line">db.runCommand( &#123; enablesharding :&quot;testdb&quot;&#125;);</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">指定数据库里需要分片的集合和片键</span></span><br><span class="line"></span><br><span class="line">db.runCommand( &#123; shardcollection : &quot;testdb.table1&quot;,key : &#123;id: 1&#125; &#125; )</span><br></pre></td></tr></table></figure>
<p>我们设置testdb的 table1 表需要分片，根据 id 自动分片到 shard1 ，shard2，shard3 上面去。要这样设置是因为不是所有mongodb 的数据库和表 都需要分片！<br>11、测试分片配置结果。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">连接mongos服务器</span></span><br><span class="line"></span><br><span class="line">/data/mongodbtest/mongodb-linux-x86_64-2.4.8/bin/mongo  127.0.0.1:20000</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">使用testdb</span></span><br><span class="line"></span><br><span class="line">use testdb;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">#插入测试数据</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MongoShard</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String args[])</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            List&lt;ServerAddress&gt; addresses = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;ServerAddress&gt;();</span><br><span class="line">            <span class="type">ServerAddress</span> <span class="variable">address1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerAddress</span>(<span class="string">&quot;localhost&quot;</span> , <span class="number">10000</span>);</span><br><span class="line">            <span class="type">ServerAddress</span> <span class="variable">address2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerAddress</span>(<span class="string">&quot;localhost&quot;</span> , <span class="number">20000</span>);</span><br><span class="line">            addresses.add(address1);</span><br><span class="line">            addresses.add(address2);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 连接到 mongodb 服务</span></span><br><span class="line">            <span class="type">MongoClient</span> <span class="variable">mongoClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MongoClient</span>(addresses);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 连接到数据库</span></span><br><span class="line">            <span class="type">MongoDatabase</span> <span class="variable">mongoDatabase</span> <span class="operator">=</span> mongoClient.getDatabase(<span class="string">&quot;testdb&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;Connect to database successfully&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            MongoCollection&lt;Document&gt; collection = mongoDatabase.getCollection(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;集合 test 选择成功&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> <span class="number">0</span>; num &lt; <span class="number">100000</span>; num++) &#123;</span><br><span class="line">                <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Document</span>(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;MYsql&quot;</span>).</span><br><span class="line">                        append(<span class="string">&quot;description&quot;</span>, <span class="string">&quot;database&quot;</span>).</span><br><span class="line">                        append(<span class="string">&quot;likes&quot;</span>, Math.random()).</span><br><span class="line">                        append(<span class="string">&quot;by&quot;</span>, <span class="string">&quot;xxx&quot;</span>).</span><br><span class="line">                        append(<span class="string">&quot;id&quot;</span>, num);</span><br><span class="line">                collection.insertOne(document);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;#################################&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.err.println(e.getClass().getName() + <span class="string">&quot;: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;+++++++++++++++++++++++++++++++&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看分片情况如下，部分无关信息省掉了</span></span><br><span class="line"></span><br><span class="line">db.table1.stats();</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&quot;sharded&quot; : true,</span><br><span class="line">	&quot;ns&quot; : &quot;testdb.table1&quot;,</span><br><span class="line">	&quot;count&quot; : 100000,</span><br><span class="line">	&quot;numExtents&quot; : 13,</span><br><span class="line">	&quot;size&quot; : 5600000,</span><br><span class="line">	&quot;storageSize&quot; : 22372352,</span><br><span class="line">	&quot;totalIndexSize&quot; : 6213760,</span><br><span class="line">	&quot;indexSizes&quot; : &#123;</span><br><span class="line">			&quot;_id_&quot; : 3335808,</span><br><span class="line">			&quot;id_1&quot; : 2877952</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;avgObjSize&quot; : 56,</span><br><span class="line">	&quot;nindexes&quot; : 2,</span><br><span class="line">	&quot;nchunks&quot; : 3,</span><br><span class="line">	&quot;shards&quot; : &#123;</span><br><span class="line">		&quot;shard1&quot; : &#123;</span><br><span class="line">			&quot;ns&quot; : &quot;testdb.table1&quot;,</span><br><span class="line">			&quot;count&quot; : 42183,</span><br><span class="line">			&quot;size&quot; : 0,</span><br><span class="line">			...</span><br><span class="line">			&quot;ok&quot; : 1</span><br><span class="line">		&#125;,</span><br><span class="line">		&quot;shard2&quot; : &#123;</span><br><span class="line">			&quot;ns&quot; : &quot;testdb.table1&quot;,</span><br><span class="line">			&quot;count&quot; : 38937,</span><br><span class="line">			&quot;size&quot; : 2180472,</span><br><span class="line">			...</span><br><span class="line">			&quot;ok&quot; : 1</span><br><span class="line">		&#125;,</span><br><span class="line">		&quot;shard3&quot; : &#123;</span><br><span class="line">			&quot;ns&quot; : &quot;testdb.table1&quot;,</span><br><span class="line">			&quot;count&quot; :18880,</span><br><span class="line">			&quot;size&quot; : 3419528,</span><br><span class="line">			...</span><br><span class="line">			&quot;ok&quot; : 1</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;ok&quot; : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到数据分到3个分片，各自分片数量为： shard1 “count” : 42183，shard2 “count” : 38937，shard3 “count” : 18880。已经成功了！不过分的好像不是很均匀，所以这个分片还是很有讲究的，后续再深入讨论。<br>12、java程序调用分片集群，因为我们配置了三个mongos作为入口，就算其中哪个入口挂掉了都没关系，使用集群客户端程序如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestMongoDBShards</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">	 <span class="keyword">try</span> &#123;</span><br><span class="line">		  List&lt;ServerAddress&gt; addresses = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;ServerAddress&gt;();</span><br><span class="line">		  <span class="type">ServerAddress</span> <span class="variable">address1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerAddress</span>(<span class="string">&quot;192.168.0.136&quot;</span> , <span class="number">20000</span>);</span><br><span class="line">		  <span class="type">ServerAddress</span> <span class="variable">address2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerAddress</span>(<span class="string">&quot;192.168.0.137&quot;</span> , <span class="number">20000</span>);</span><br><span class="line">		  <span class="type">ServerAddress</span> <span class="variable">address3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerAddress</span>(<span class="string">&quot;192.168.0.138&quot;</span> , <span class="number">20000</span>);</span><br><span class="line">		  addresses.add(address1);</span><br><span class="line">		  addresses.add(address2);</span><br><span class="line">		  addresses.add(address3);</span><br><span class="line">	</span><br><span class="line">		  <span class="type">MongoClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MongoClient</span>(addresses);</span><br><span class="line">		  <span class="type">DB</span> <span class="variable">db</span> <span class="operator">=</span> client.getDB( <span class="string">&quot;testdb&quot;</span> );</span><br><span class="line">		  <span class="type">DBCollection</span> <span class="variable">coll</span> <span class="operator">=</span> db.getCollection( <span class="string">&quot;table1&quot;</span> );</span><br><span class="line">	</span><br><span class="line">		  <span class="type">BasicDBObject</span> <span class="variable">object</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BasicDBObject</span>();</span><br><span class="line">		  object.append( <span class="string">&quot;id&quot;</span> , <span class="number">1</span>);</span><br><span class="line">	</span><br><span class="line">		  <span class="type">DBObject</span> <span class="variable">dbObject</span> <span class="operator">=</span> coll.findOne(object);</span><br><span class="line">	</span><br><span class="line">		  System. out .println(dbObject);</span><br><span class="line">	</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		  e.printStackTrace();</span><br><span class="line">	&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个分片集群搭建完了，思考一下我们这个架构是不是足够好呢？其实还有很多地方需要优化，比如我们把所有的仲裁节点放在一台机器，其余两台机器承担了全部读写操作，但是作为仲裁的192.168.0.138相当空闲。让机器3 192.168.0.138多分担点责任吧！架构可以这样调整，把机器的负载分的更加均衡一点，每个机器既可以作为主节点、副本节点、仲裁节点，这样压力就会均衡很多了，如图：</p>
<p>当然生产环境的数据远远大于当前的测试数据，大规模数据应用情况下我们不可能把全部的节点像这样部署，硬件瓶颈是硬伤，只能扩展机器。要用好mongodb还有很多机制需要调整，不过通过这个东东我们可以快速实现高可用性、高扩展性，所以它还是一个非常不错的Nosql组件。</p>
<p>再看看我们使用的mongodb java 驱动客户端 MongoClient(addresses)，这个可以传入多个mongos 的地址作为mongodb集群的入口，并且可以实现自动故障转移，但是负载均衡做的好不好呢？打开源代码查看：</p>
<p>它的机制是选择一个ping 最快的机器来作为所有请求的入口，如果这台机器挂掉会使用下一台机器。那这样。。。。肯定是不行的！万一出现双十一这样的情况所有请求集中发送到这一台机器，这台机器很有可能挂掉。一但挂掉了，按照它的机制会转移请求到下台机器，但是这个压力总量还是没有减少啊！下一台还是可能崩溃，所以这个架构还有漏洞！不过这个文章已经太长了，后续解决吧。</p>
<p>##配置文件</p>
<p>以下是个人测试时的使用的配置文件：</p>
<p>###mongos</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">port</span>=<span class="string">10000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logpath</span>=<span class="string">D:\MongoDB\repset\rep_a\mongos\logs\rep_a_mongos.log</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#日志信息在日志文件中累加而不是覆盖</span></span><br><span class="line"><span class="attr">logappend</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#配置数据库地址</span></span><br><span class="line"><span class="attr">configdb</span>=<span class="string">rsconf/localhost:11000,localhost:21000</span></span><br></pre></td></tr></table></figure>
<p>###configdb</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">port</span>=<span class="string">11000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dbpath</span>=<span class="string">D:\MongoDB\repset\rep_a\configdb\data</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logpath</span>=<span class="string">D:\MongoDB\repset\rep_a\configdb\logs\rep_a_configdb.log</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#日志信息在日志文件中累加而不是覆盖</span></span><br><span class="line"><span class="attr">logappend</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#代表启动日志</span></span><br><span class="line"><span class="attr">journal</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#表允许通过http方式来访问jsonp格式数据</span></span><br><span class="line"><span class="comment">#jsonp=true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#RESTFUL</span></span><br><span class="line"><span class="attr">rest</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#配置数据库</span></span><br><span class="line"><span class="attr">configsvr</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#分片</span></span><br><span class="line"><span class="attr">replSet</span>=<span class="string">rsconf</span></span><br></pre></td></tr></table></figure>
<p>###rep_a&#x2F;shard_a</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">port</span>=<span class="string">10001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dbpath</span>=<span class="string">D:\MongoDB\repset\rep_a\shard_a\data</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logpath</span>=<span class="string">D:\MongoDB\repset\rep_a\shard_a\logs\rep_a_shard_a.log</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#日志信息在日志文件中累加而不是覆盖</span></span><br><span class="line"><span class="attr">logappend</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#代表启动日志</span></span><br><span class="line"><span class="attr">journal</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#表允许通过http方式来访问jsonp格式数据</span></span><br><span class="line"><span class="comment">#jsonp=true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#RESTFUL</span></span><br><span class="line"><span class="attr">rest</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#启动分片</span></span><br><span class="line"><span class="attr">shardsvr</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#设置副本集</span></span><br><span class="line"><span class="attr">replSet</span>=<span class="string">rep_shard_1</span></span><br></pre></td></tr></table></figure>
<p>###rep_a&#x2F;shard_b</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">port</span>=<span class="string">10002</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dbpath</span>=<span class="string">D:\MongoDB\repset\rep_a\shard_b\data</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logpath</span>=<span class="string">D:\MongoDB\repset\rep_a\shard_b\logs\rep_a_shard_b.log</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#日志信息在日志文件中累加而不是覆盖</span></span><br><span class="line"><span class="attr">logappend</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#代表启动日志</span></span><br><span class="line"><span class="attr">journal</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#表允许通过http方式来访问jsonp格式数据</span></span><br><span class="line"><span class="comment">#jsonp=true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#RESTFUL</span></span><br><span class="line"><span class="attr">rest</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#启动分片</span></span><br><span class="line"><span class="attr">shardsvr</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#设置副本集</span></span><br><span class="line"><span class="attr">replSet</span>=<span class="string">rep_shard_2</span></span><br></pre></td></tr></table></figure>
<p>###rep_a&#x2F;shard_c</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">port</span>=<span class="string">10003</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dbpath</span>=<span class="string">D:\MongoDB\repset\rep_a\shard_c\data</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logpath</span>=<span class="string">D:\MongoDB\repset\rep_a\shard_c\logs\rep_a_shard_c.log</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#日志信息在日志文件中累加而不是覆盖</span></span><br><span class="line"><span class="attr">logappend</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#代表启动日志</span></span><br><span class="line"><span class="attr">journal</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#表允许通过http方式来访问jsonp格式数据</span></span><br><span class="line"><span class="comment">#jsonp=true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#RESTFUL</span></span><br><span class="line"><span class="attr">rest</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#启动分片</span></span><br><span class="line"><span class="attr">shardsvr</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#设置副本集</span></span><br><span class="line"><span class="attr">replSet</span>=<span class="string">rep_shard_3</span></span><br></pre></td></tr></table></figure>
        </div>
        <div class="post-tool">
            <a class="btn-weixin-mp" href="javascript:void(0);" data-cid="52" title="95">
                <i class="fa fa-mobile" aria-hidden="true"></i> 打赏
            </a>
        </div>
        
        <div class="post-tags">标签：
            
            <a href="/blog/tags/MongoDB/">MongoDB</a>
            
        </div>
        
    </article>
    
<div id="disqus_thread"></div>

<div class="clearfix" style="margin-top: 40px;">
</div>
<!-- UY BEGIN -->
<div id="uyan_frame"></div>
<!-- UY END -->

<!--PC版-->
<div id="SOHUCS" sid="12345678"></div>
<script charset="utf-8" type="text/javascript" src="https://cy-cdn.kuaizhan.com/upload/changyan.js" ></script>
<script type="text/javascript">
    window.changyan.api.config({
        appid: 'cyvlGm1zt',
        conf: 'prod_ed7bcebba567a04ee0d7b6bd13d280f8'
    });

    $(function () {
        function hash(text) {
            'use strict';
            var hash = 5381,
                index = text.length;
            while (index) {
                hash = (hash * 33) ^ text.charCodeAt(--index);
            }
            return hash >>> 0;
        }

        $('#SOHUCS').attr({
            "sid": hash(window.location.pathname)
        });
    });
</script>


<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    <!--添加友言评论系统，注释以下代码-->
    //  var disqus_config = function () {
    //      this.page.url = 'http://wuzguo.com/blog/2017/02/16/db/mongodb_slice.html';
    //      this.page.identifier = '2017/02/16/db/mongodb_slice.html';
    //  };
    //  (function () { // DON'T EDIT BELOW THIS LINE
    //      var d = document, disqus_shortname = 'wuzguo', s = d.createElement('script');
    //      s.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
    //      s.setAttribute('data-timestamp', +new Date());
    //      (d.head || d.body).appendChild(s);
    //  })();
</script>

<!--添加友言评论系统，注释以下代码-->
<!--<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>-->

</div>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        </div><!-- end #main-->


    </div><!-- end #body -->
    <footer class="footer">
    <div class="footer-inner">
        <p>
            <a href="/blog/about/" title="关于本站">关于本站</a>&nbsp;&nbsp<em>·</em>&nbsp;&nbsp
            <a href="/blog/help/" title="帮助">帮助</a>&nbsp;&nbsp<em>·</em>&nbsp;&nbsp
            <a href="/blog/video/" title="视频">视频</a>&nbsp;&nbsp<em>·</em>&nbsp;&nbsp
            <!-- 自定义链接 -->
            <a href="/blog/links/" title="友情链接">友情链接</a>&nbsp;&nbsp<em>·</em>&nbsp;&nbsp
            <a href="/blog/app/" title="应用下载">应用下载</a>
        </p>
        <br/>
        <p>哪有什么天生如此，只要你天天坚持，自律给你自由</p>
        <br/>
        <p>
            © 2016-2021 本站点基于<a href="http://hexo.io" target="_blank">Hexo</a>搭建
            ，主题作者<a href="https://www.tangkunyin.com" target="_blank">唐先森</a>，
            采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/"
                 target="_blank">知识共享署名-非商业性使用-相同方式共享4.0国际许可协议</a>，已建站<a href="/timeline"
                                                                         id="siteBuildingTime"></a>天<br/>
        </p>
        
<p>
    <script type="text/javascript">
        document.write(unescape("%3Cspan id='cnzz_stat_icon_1262530944'%3E%3C/span%3E%3Cscript src='//s4.cnzz.com/stat.php%3Fid%3D1262530944%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));
    </script>
</p>

    </div>
</footer>
<script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>

<script src="/blog/css/highlight/highlight.pack.js"></script>
<script src="/blog/js/InsightSearch.js"></script>
<script src="/blog/js/SimpleCore.js"></script>


</div>
<div class="fixed-btn">
    <a class="btn-gotop" href="javascript:"> <i class="fa fa-angle-up"></i></a>
</div>

<script>
    $(function () {
        SimpleCore.init({
            buildingTime: '04/24/2016',
            current: $('.post-tags').length > 0 ? 'post' : 'archive',
            customImg: '/blog/images/weixin-mp.png'
        });

        <!--代码高亮-->
        $('.code pre').each(function (i, block) {
            hljs.highlightBlock(block);
        });
    });
</script>
<script src="/blog/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/blog/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":145,"height":315},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body>
</html>